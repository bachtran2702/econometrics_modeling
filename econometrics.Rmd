---
title: "econometrics"
author: "Bach Tran"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(PerformanceAnalytics)
library(stats)
library(tidyr)
library(tseries) 
library(TTR)
library(zoo)
library(forecast)
library(lubridate)
library(car) 
library(ggplot2)
library(quantmod)
library(tsibble)
library(xts)
library(tibble)
library(fpp3)
library(extrafont)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


```{r macro data, echo = T}
#wrestle the data from chr type "%m/%d/%y" data to zoo type year month 
dta = read.csv("base_model_dta.csv", col.names = c("month", "unemployment_r", "fed_fund_r", "consumer_sent")) %>%
  mutate(month = as.character(
    as.Date(month, format = "%m/%d/%y"))
  ) %>%
  mutate(month = yearmonth(month))
```

```{r sp500 performance data, echo =T}
#subset period
start = "2018-09-01"
end = "2024-10-31"

# Assign SPY data to 'spy' 
spy = getSymbols("SPY", auto.assign = F, from = start, to = end)

#Extract adjusted close
spy_adj = Ad(spy) 
monthly_spy_adj = apply.monthly(spy_adj, FUN = mean)

#convert xts to data frame
spy_df = as.data.frame(monthly_spy_adj) %>%
  rownames_to_column(var = "month")
#wrestle the data to year month
spy_df = spy_df%>%
  mutate(month = yearmonth(month))
```


```{r tsible, echo=FALSE}
combined = merge(dta, spy_df)

analysis_rdy_tsibble = combined%>%
  as_tsibble(index = month)
```

```{r trend visualization, echo=FALSE}
#as time series
library("PerformanceAnalytics")


ggplot(combined, aes(x = month)) +
    geom_line(aes(y = unemployment_r), color = "#ED3833") +
    geom_line(aes(y = fed_fund_r), color ="#073D7F") +
    labs(y = "Price ", x = "Year" )
                          
#higher unemployment earlier of the year, lower at the end of the year; unemployment in 2024 is on par with non-pandemic year 
gg_season(analysis_rdy_tsibble, unemployment_r)
gg_subseries(analysis_rdy_tsibble, unemployment_r)


#no clear trend in stock performance  M-o-M. Market is at an all tiome high and continue growing 
#I changed the color scale because this is just slightly easier to see compare to the default.
gg_season(analysis_rdy_tsibble, SPY.Adjusted, pal = (scales::viridis_pal())(9))
gg_subseries(analysis_rdy_tsibble,  SPY.Adjusted)
```
```{r impute model, echo=FALSE}
#model fit a model to predict consumer sentiment for October
fit_csi = lm(consumer_sent ~ unemployment_r + fed_fund_r + SPY.Adjusted + month + fed_fund_r:SPY.Adjusted, data = analysis_rdy_tsibble)
summary(fit_csi)

oct_data = tibble(unemployment_r = 3.9, fed_fund_r =4.83, SPY.Adjusted = 577.7850, 
                       month = yearmonth("2024-10"))
imputed_data = as.numeric(predict(fit_csi, oct_data))

#linear model assumptions check
# pass the residuals of linear regression model
res = resid(fit_csi) 
# residual plot 
plot(fit_csi,1)
# QQ plot
plot(fit_csi,2)
# scale-location-plot
plot(fit_csi,3)
# stats test. Since p-value > 0.05, residuals arae normally distributed
shapiro.test(residuals(fit_csi)) 
```

```{r impute data, echo=FALSE}  
#impute the missing October data
analysis_rdy_tsibble = analysis_rdy_tsibble %>%
  replace_na(list(consumer_sent = imputed_data))
tail(analysis_rdy_tsibble, n = 1)
```

```{r descriptive stats, echo=FALSE}
#descriptive data
data_no_date = analysis_rdy_tsibble%>%
  as_tibble()%>%
  select(-month)
cor_matrix = chart.Correlation(data_no_date)

summary(data_no_date)

#normalize data
#Foundation done. Now look for a company then forecast the industry performance.
        
```

```{r forecast SP500, echo=FALSE}
#base model: 
fit = auto.arima(analysis_rdy_tsibble$SPY.Adjusted)
summary(fit)

#model 2
fit2 = auto.arima(analysis_rdy_tsibble$SPY.Adjusted, stepwise = F)
summary(fit2)
fit2%>%forecast(h=12)%>% autoplot()

#model 3
#regressors matrix
xreg = cbind(fed_fund_r = as.numeric(unlist(analysis_rdy_tsibble[,"fed_fund_r"])),
             unemployment_r= as.numeric(unlist(analysis_rdy_tsibble[,"unemployment_r"])),
             consumer_sent = as.numeric(unlist(analysis_rdy_tsibble[,"consumer_sent"])))

fit_sp = auto.arima(analysis_rdy_tsibble[,"SPY.Adjusted"], xreg = xreg, stepwise = F,seasonal = T)

summary(fit_sp)
analysis_rdy_tsibble%>%
  gg_tsdisplay(SPY.Adjusted)

# Use model 3 because it performs best.assumptions for final model
csi_model = auto.arima(analysis_rdy_tsibble[,"consumer_sent"], stepwise = F) #AIC is high, large se bands, more uncertainty. Therefore:

# flat lining rate at 3% fed fund r, consumer sentiment is from 70 to 80 with an increase of 2 monthly based on market reaction toward political events
new_data = cbind( fed_fund_r = rep(4.6,12), 
                  unemployment_r= rep(3.8,12),
                  consumer_sent =seq(70,94,2))

#forecast
fc = forecast(fit_sp, xreg = new_data,h = 12)

checkresiduals(fc)

```


```{r forecast model vis, echo=FALSE, warning = F}
#fix date index
month_index = as.ts(seq(as.Date("2018-09-01"), as.Date("2025-10-1"), by = "1 month"))
month_index_list = as.list(month_index)

#Unused code
plot_model = fc
plot_model["x"] = as.list(month_index)

#"S&P 500 Performance
autoplot(fc) + aes(color = "#ED3833", labels = "Historical Data") +
  ylim(200,800) +
  #scales
  scale_y_continuous(n.breaks = 10) +
  labs(x= "", y = "Dollars", caption = "Time Index: 1 = September 2018 ") +
    #positions of title
  theme(text=element_text(family="Calibri"),
        plot.title = element_blank(),
    #plot caption
        plot.caption.position =  "plot",
        plot.caption = element_text(hjust = 0)) +
  theme(panel.grid.major.y = element_line(color = "#DDD9C3"),
        panel.background = element_blank())  +
    
    #remove background and tick marks and leend
  theme(axis.ticks.y = element_blank(),
        axis.line = element_line(color = "black", size = 0.75, linetype = "solid"),
        legend.position = "none")

```



## Including Plots


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
